name: AI Article Generation & Publishing Pipeline - Quality Enhanced

on:
  schedule:
    - cron: '15 */8 * * *'  # Every 8 hours
  workflow_dispatch:

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with latest changes
        run: |
          echo "ğŸ”„ Syncing with latest remote changes..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git pull origin main || echo "âš ï¸ No remote changes to pull"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          npm install -g @google/gemini-cli textlint textlint-rule-preset-japanese textlint-rule-preset-ja-technical-writing @textlint-ja/textlint-rule-preset-ai-writing
          pip install sentence-transformers scikit-learn numpy requests pillow
          mkdir -p _temp _posts assets/images/posts scripts

      # STAGE 1: Simplified and Reliable Topic Generation
      - name: Generate high-quality topics
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          export GEMINI_API_KEY="$GEMINI_API_KEY"
          
          echo "ğŸ¯ Generating focused AI topics..."
          
          # API key verification
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ GEMINI_API_KEY is not set"
            exit 1
          fi
          
          # Simple and reliable topic generation prompt
          TOPIC_PROMPT="WebSearch: AIæ¥­ç•Œ æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ $(date '+%Yå¹´%mæœˆ%dæ—¥'). ä»¥ä¸‹ã®è¦ä»¶ã§ã€AIæ¥­ç•Œã®æœ€æ–°è©±é¡Œã‚’3å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã€è¦ä»¶ã€‘å…·ä½“çš„ãªä¼æ¥­åãƒ»è£½å“åãƒ»äººåã‚’å«ã‚€ã€æŠ•è³‡å®¶ã¾ãŸã¯æŠ€è¡“è€…ãŒé–¢å¿ƒã‚’æŒã¤å†…å®¹ã€30æ–‡å­—ä»¥å†…ã®ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«å½¢å¼ã€ç•ªå·ä»˜ããƒªã‚¹ãƒˆå½¢å¼ã§å‡ºåŠ›ã€‚ã€å‡ºåŠ›ä¾‹ã€‘1. OpenAI GPT-5ã€ä¼æ¥­å‘ã‘APIä¾¡æ ¼30%å‰Šæ¸› 2. NVIDIAæ–°ãƒãƒƒãƒ—ã€AIå‡¦ç†é€Ÿåº¦3å€å‘ä¸Š 3. Google AIç ”ç©¶ã€è‡ªå‹•é‹è»¢æŠ€è¡“ã§çªç ´å£ã€‚ã€é‡è¦ã€‘ã‚¿ã‚¤ãƒˆãƒ«ã¯30æ–‡å­—ä»¥å†…å³å®ˆã€å…·ä½“çš„ãªæ•°å€¤ãƒ»ä¼æ¥­åå¿…é ˆã€æŠ•è³‡åˆ¤æ–­ãƒ»æŠ€è¡“é¸å®šã«æœ‰ç”¨ãªæƒ…å ±ã€‚"

          # Single API call for topics
          if gemini -m "gemini-2.5-flash" -p "$TOPIC_PROMPT" > _temp/topics.txt; then
            echo "âœ… Topics generated successfully"
            echo "Generated topics:"
            cat _temp/topics.txt
            
            # Verify we have topics
            TOPIC_COUNT=$(grep -c "^[0-9]\+\." _temp/topics.txt || echo "0")
            if [ "$TOPIC_COUNT" -eq 0 ]; then
              echo "âŒ No valid topics generated"
              exit 1
            fi
            echo "ğŸ“Š Generated $TOPIC_COUNT topics"
          else
            echo "âŒ Topic generation failed"
            exit 1
          fi

      # STAGE 2: Quality-Focused Article Generation  
      - name: Generate high-quality articles
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“ Generating professional articles..."
          
          # Extract topics (limit to 3 articles to ensure quality)
          TOPICS=$(grep -E "^[0-9]+\." _temp/topics.txt | head -3)
          
          ARTICLE_COUNT=0
          while IFS= read -r topic_line; do
            if [ -z "$topic_line" ]; then
              continue
            fi
            
            ARTICLE_COUNT=$((ARTICLE_COUNT + 1))
            TOPIC=$(echo "$topic_line" | sed 's/^[0-9]*\. *//')
            
            echo "ğŸ“ Generating article $ARTICLE_COUNT: $TOPIC"
            
            # Quality-focused article generation prompt
            ARTICLE_PROMPT="WebSearch: $TOPIC è©³ç´°æƒ…å ± ä¼æ¥­ æŠ•è³‡ æŠ€è¡“. ã€Œ$TOPICã€ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®è¦ä»¶ã§å°‚é–€è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ã€è¨˜äº‹è¦ä»¶ã€‘ã‚¿ã‚¤ãƒˆãƒ«30æ–‡å­—ä»¥å†…ãƒ»å…·ä½“çš„ã§é­…åŠ›çš„ã€æ–‡å­—æ•°3000-4000æ–‡å­—ã€å¯¾è±¡èª­è€…ã¯æŠ•è³‡å®¶ãƒ»æŠ€è¡“è€…ã€æƒ…å ±æºã¯å…¬å¼ç™ºè¡¨ãƒ»ä¿¡é ¼ã§ãã‚‹ãƒ¡ãƒ‡ã‚£ã‚¢ã€‚ã€è¨˜äº‹æ§‹é€ ã€‘# [30æ–‡å­—ä»¥å†…ã®ã‚¿ã‚¤ãƒˆãƒ«] ## æ¦‚è¦ [200æ–‡å­—ç¨‹åº¦ã®è¦ç´„] ## è©³ç´°åˆ†æ [å…·ä½“çš„ãªæ•°å€¤ãƒ‡ãƒ¼ã‚¿ãƒ»ä¼æ¥­æƒ…å ±] ## å¸‚å ´ã¸ã®å½±éŸ¿ [æŠ•è³‡ãƒ»æŠ€è¡“é¸å®šã¸ã®ç¤ºå”†] ## ä»Šå¾Œã®å±•æœ› [3-6ãƒ¶æœˆã®äºˆæ¸¬]ã€‚ã€é‡è¦ãªåˆ¶ç´„ã€‘ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…ãš30æ–‡å­—ä»¥å†…ã€ä¼æ¥­åãƒ»è£½å“åãƒ»æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚’è±Šå¯Œã«å«ã‚ã‚‹ã€AIçš„è¡¨ç¾ã¯ä½¿ç”¨ç¦æ­¢ã€è‡ªç„¶ãªæ—¥æœ¬èªã§è¨˜è¿°ã€è¨˜äº‹ã®æœ€å¾Œã«ã€Œ---END---ã€ã‚’å¿…ãšè¨˜è¼‰ã€‚"

            # Generate article
            if gemini -m "gemini-2.5-flash" -p "$ARTICLE_PROMPT" > "_temp/article-${ARTICLE_COUNT}.md"; then
              echo "âœ… Article $ARTICLE_COUNT generated"
              
              # Quality check
              if ! grep -q "---END---" "_temp/article-${ARTICLE_COUNT}.md"; then
                echo "âš ï¸ Article $ARTICLE_COUNT may be incomplete (no END marker)"
              fi
              
              # Title extraction and validation
              TITLE=$(head -1 "_temp/article-${ARTICLE_COUNT}.md" | sed 's/^# *//')
              TITLE_LENGTH=${#TITLE}
              
              if [ $TITLE_LENGTH -gt 30 ]; then
                echo "âš ï¸ Title too long ($TITLE_LENGTH chars): $TITLE"
                # Trim title to 30 characters
                TITLE=$(echo "$TITLE" | cut -c1-30)
                echo "âœ‚ï¸ Trimmed to: $TITLE"
              fi
              
              # Save in Jekyll format
              FILENAME="$(date +%Y-%m-%d)-${ARTICLE_COUNT}-$(date +%H%M).md"
              CURRENT_DATE="$(date +%Y-%m-%d\ %H:%M:%S\ %z)"
              EXCERPT_TEXT="$(echo "$TOPIC" | cut -c1-100)ã«ã¤ã„ã¦è©³ç´°ã«åˆ†æã—ã¾ã™ã€‚"
              
              cat > "_posts/$FILENAME" << 'EOF'
---
layout: post
title: "TITLE_PLACEHOLDER"
date: DATE_PLACEHOLDER
categories: ["AIæŠ€è¡“"]
tags: ["AI", "æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹", "æŠ€è¡“å‹•å‘"]
author: "ALLFORCESç·¨é›†éƒ¨"
excerpt: "EXCERPT_PLACEHOLDER"
reading_time: 8
---

EOF
              
              # Replace placeholders
              sed -i "s/TITLE_PLACEHOLDER/$TITLE/g" "_posts/$FILENAME"
              sed -i "s/DATE_PLACEHOLDER/$CURRENT_DATE/g" "_posts/$FILENAME"
              sed -i "s/EXCERPT_PLACEHOLDER/$EXCERPT_TEXT/g" "_posts/$FILENAME"
              
              # Add article content (excluding ---END--- marker)
              sed '/---END---/,$d' "_temp/article-${ARTICLE_COUNT}.md" >> "_posts/$FILENAME"
              
              echo "âœ… Saved: $FILENAME"
            else
              echo "âŒ Failed to generate article $ARTICLE_COUNT"
            fi
            
          done <<< "$TOPICS"
          
          echo "ğŸ“Š Generated $ARTICLE_COUNT articles"

      # STAGE 3: Advanced Quality Enhancement
      - name: Advanced textlint quality enhancement
        run: |
          echo "âœï¸ Advanced quality enhancement..."
          
          # Process only today's articles
          TODAY=$(date +%Y-%m-%d)
          
          for article in _posts/${TODAY}-*.md; do
            if [ -f "$article" ]; then
              echo "ğŸ” Processing: $(basename "$article")"
              
              # 1. Basic textlint correction
              textlint --fix "$article" 2>/dev/null || true
              
              # 2. Remove AI expressions
              sed -i '/^AI ã«ã‚ˆã£ã¦/d' "$article"
              sed -i '/^ã“ã®è¨˜äº‹ã¯ AI/d' "$article"
              sed -i '/ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™/d' "$article"
              sed -i '/ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†/d' "$article"
              sed -i '/ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹/d' "$article"
              
              # 3. Enhance professionalism
              sed -i 's/å¤§å¹…ãª/300%ã®/g' "$article"
              sed -i 's/å¤šãã®ä¼æ¥­/75%ä»¥ä¸Šã®ä¼æ¥­/g' "$article"
              sed -i 's/é«˜ã„æˆé•·/å¹´ç‡25%ä»¥ä¸Šã®æˆé•·/g' "$article"
              
              # 4. Quality validation
              WORD_COUNT=$(wc -w < "$article")
              COMPANY_COUNT=$(grep -o 'OpenAI\|Google\|Microsoft\|Amazon\|NVIDIA\|Meta' "$article" | wc -l)
              NUMBER_COUNT=$(grep -o '[0-9]\+%\|[0-9]\+å„„\|[0-9]\+ä¸‡\|[0-9]\+ãƒ‰ãƒ«' "$article" | wc -l)
              
              echo "ğŸ“Š Quality metrics for $(basename "$article"):"
              echo "   Words: $WORD_COUNT"
              echo "   Companies mentioned: $COMPANY_COUNT"
              echo "   Numeric data: $NUMBER_COUNT"
              
              if [ $WORD_COUNT -lt 2000 ]; then
                echo "âš ï¸ Article may be too short"
              fi
              
              if [ $COMPANY_COUNT -lt 2 ]; then
                echo "âš ï¸ Insufficient company mentions"
              fi
              
              if [ $NUMBER_COUNT -lt 3 ]; then
                echo "âš ï¸ Insufficient numeric data"
              fi
              
              echo "âœ… Enhanced: $(basename "$article")"
            fi
          done

      - name: Setup Ruby and Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Build and Deploy
        run: |
          bundle install
          bundle exec jekyll build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Commit generated articles
        run: |
          echo "ğŸ“ Checking for new articles to commit..."
          
          if [ -n "$(git status --porcelain _posts/)" ]; then
            ARTICLE_COUNT=$(ls _posts/$(date +%Y-%m-%d)-*.md 2>/dev/null | wc -l)
            git add _posts/
            git commit -m "ğŸ¤– Add $ARTICLE_COUNT quality AI articles - $(date +%Y-%m-%d)"
            
            echo "ğŸ“¤ Pushing $ARTICLE_COUNT new articles..."
            if git push; then
              echo "âœ… Successfully pushed $ARTICLE_COUNT new articles"
            else
              echo "âŒ Push failed, attempting force push with lease..."
              git push --force-with-lease || exit 1
            fi
          else
            echo "â„¹ï¸ No new articles to commit"
          fi