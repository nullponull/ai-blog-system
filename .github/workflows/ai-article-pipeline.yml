name: AI Article Generation & Publishing Pipeline

on:
  schedule:
    - cron: '15 * * * *'  # 毎時15分に実行
    - cron: '37 * * * *'  # 毎時37分に実行
    - cron: '52 * * * *'  # 毎時52分に実行
  workflow_dispatch:      # 手動実行も可能

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install
          npm install -g @google/gemini-cli
          mkdir -p _temp

      - name: Generate topic list for AI industry
        id: generate_topics
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          export GEMINI_API_KEY="$GEMINI_API_KEY"
          DATE_STR=$(date '+%Y年%m月%d日')
          
          # Generate list of current AI topics
          gemini -m "gemini-2.5-flash" --prompt "WebSearch: ${DATE_STR} AI業界 最新ニュース トレンド 話題。今日(${DATE_STR})のAI業界で注目されている話題・トレンドをWeb検索で調査し、以下の形式で10個の具体的な話題をリストアップしてください。各話題は1行で、簡潔に表現してください。例: 1. OpenAIの新モデル発表, 2. Google DeepMindの研究成果, 3. 生成AIの企業導入事例, 4. AI規制法案の動向, 5. 自動運転技術の進展...実際の検索結果に基づいて、具体的な企業名・製品名・人名を含めた現実的な話題を10個リストアップしてください。" > _temp/topics-list.txt
          
          echo "Generated topics list:"
          cat _temp/topics-list.txt

      - name: Select unused topic and generate article
        id: generate_article
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          export GEMINI_API_KEY="$GEMINI_API_KEY"
          DATE_STR=$(date '+%Y年%m月%d日')
          
          # Extract topics from the generated list
          TOPICS=$(grep -E "^[0-9]+\." _temp/topics-list.txt | head -10)
          echo "Available topics:"
          echo "$TOPICS"
          
          # Check existing articles to avoid duplicates
          EXISTING_TITLES=""
          if ls _posts/*.md 1> /dev/null 2>&1; then
            EXISTING_TITLES=$(grep -h "^title:" _posts/*.md 2>/dev/null | tail -20 || echo "")
          fi
          
          # Select a random topic from the list
          TOPIC_COUNT=$(echo "$TOPICS" | wc -l)
          RANDOM_INDEX=$((RANDOM % TOPIC_COUNT + 1))
          SELECTED_TOPIC=$(echo "$TOPICS" | sed -n "${RANDOM_INDEX}p" | sed 's/^[0-9]*\. *//')
          
          # If selected topic seems too similar to existing titles, try another one
          if [ ! -z "$EXISTING_TITLES" ]; then
            for i in {1..5}; do
              if echo "$EXISTING_TITLES" | grep -qi "$(echo "$SELECTED_TOPIC" | cut -d' ' -f1-2)"; then
                RANDOM_INDEX=$((RANDOM % TOPIC_COUNT + 1))
                SELECTED_TOPIC=$(echo "$TOPICS" | sed -n "${RANDOM_INDEX}p" | sed 's/^[0-9]*\. *//')
              else
                break
              fi
            done
          fi
          echo "Selected topic: $SELECTED_TOPIC"
          
          # Generate article based on selected topic
          gemini -m "gemini-2.5-flash" --prompt "WebSearch: ${DATE_STR} ${SELECTED_TOPIC} AI業界。今日(${DATE_STR})の「${SELECTED_TOPIC}」について、Web検索で最新情報を調査し、技術者向けの詳細な記事を日本語で作成してください。要件：実際の最新検索結果に基づいた具体的で詳細な内容、技術的な詳細説明、企業・人名・製品名・数値データを具体的に記載、自然な日本語表現（AI特有の機械的表現は避ける）、3000-4000文字程度、Markdown形式で出力（ただしコードブロック記号は使わない）。構成例：# ${SELECTED_TOPIC}：${DATE_STR}の最新動向 ## 概要と背景 ## 最新の発表・発見内容 ## 技術的な詳細と仕組み ## 業界への影響と意義 ## 競合他社の動向 ## 今後の展望。Web検索で得た最新情報を基に、技術的な詳細、具体的な数値、企業名、人名などを含めてリアルなニュース記事として作成してください。" > _temp/new-article.md
          
          # もしgemini-cliが失敗した場合はPythonスクリプトにフォールバック
          if [ ! -f "_temp/new-article.md" ] || [ ! -s "_temp/new-article.md" ]; then
            echo "Gemini CLI failed, falling back to Python script"
            python generate_article_standalone.py
          fi

      - name: Lint and Fix Generated Article
        run: |
          # textlintで記事を校正（エラーがあっても継続）
          if [ -f "_temp/new-article.md" ]; then
            npx textlint _temp/new-article.md --fix || echo "Textlint completed with warnings"
          else
            echo "Article file not found, skipping textlint"
          fi

      - name: Create final article file
        run: |
          # 記事タイトルを取得（より堅牢な処理）
          TITLE=$(grep -m 1 "^# " _temp/new-article.md | sed 's/^# //' | sed 's/[[:space:]]*$//')
          
          # タイトルが取得できない場合は日付ベースのタイトルを使用
          if [ -z "$TITLE" ] || [ "$TITLE" = "markdown" ] || [[ "$TITLE" == *'```'* ]]; then
            TITLE="${DATE_STR}のAI業界ニュース"
          fi
          
          # ファイル名用にタイトルを変換
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          
          # 日付ベースのファイル名
          FILENAME="$(date +%Y-%m-%d)-$SLUG.md"
          
          # Front matterを作成
          cat > "_posts/$FILENAME" << EOF
          ---
          layout: post
          title: "$TITLE"
          date: $(date +%Y-%m-%d\ %H:%M:%S\ %z)
          categories: ["AI技術", "最新動向"]
          tags: ["AI", "機械学習", "技術解説", "最新研究"]
          author: "AI記事生成システム"
          excerpt: "最新のAI技術動向について、Google検索で調査した最新情報を基に詳しく解説します。"
          reading_time: 8
          ---
          EOF
          
          # 記事本文を追加（markdownコードブロック記号を除去）
          sed '1d' _temp/new-article.md | sed '/^```markdown$/d' | sed '/^```$/d' >> "_posts/$FILENAME"
          
          echo "Generated article: $FILENAME"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Install Jekyll dependencies
        run: |
          # Gemfileが既に存在するので、bundlerで依存関係をインストール
          bundle install

      - name: Build with Jekyll
        run: bundle exec jekyll build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          timeout: 60000  # 1 minute timeout

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add _posts/*
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: Add new AI article - $(date +%Y-%m-%d)"
            git push
          fi